package users_test

import (
	"context"
	"encoding/json"
	"fmt"
	"net/http"
	"testing"

	"github.com/gurch101/gowebutils/internal/users"
	"github.com/gurch101/gowebutils/pkg/testutils"
)

func TestCreateUser(t *testing.T) {
	t.Parallel()

	t.Run("successful create", func(t *testing.T) {
		app := testutils.NewTestApp(t)
		defer app.Close()

		controller := users.NewCreateUserController(app.App)
		app.TestRouter.Post("/users", controller.CreateUserHandler)

		body := users.CreateTestUserRequest(t)

		req := testutils.CreatePostRequest(t, "/users", body)
		rr := app.MakeRequest(req)

		if rr.Code != http.StatusCreated {
			t.Errorf("expected status code %d, got %d", http.StatusCreated, rr.Code)
		}

		var response users.CreateUserResponse
		err := json.Unmarshal(rr.Body.Bytes(), &response)
		if err != nil {
			t.Fatal(err)
		}

		if response.ID <= 0 {
			t.Errorf("expected ID to be positive, got %d", response.ID)
		}

		location := rr.Header().Get("Location")
		if location == "" {
			t.Errorf("expected Location header to be set")
		}

		if location != fmt.Sprintf("/users/%d", response.ID) {
			t.Errorf("expected Location header to be %s, got %s", fmt.Sprintf("/users/%d", response.ID), location)
		}

		var name string
		var email string
		var someInt64 int64
		var someBool bool

		err = app.DB().QueryRowContext(context.Background(), fmt.Sprintf("SELECT  name  ,email  ,some_int64  ,some_bool  FROM users WHERE id = %d", response.ID)).Scan(
			&name,
			&email,
			&someInt64,
			&someBool,
		)
		if err != nil {
			t.Fatal(err)
		}
		if name != body.Name {
			t.Errorf("expected name to be %v, got %v", body.Name, name)
		}
		if email != body.Email {
			t.Errorf("expected email to be %v, got %v", body.Email, email)
		}
		if someInt64 != body.SomeInt64 {
			t.Errorf("expected someInt64 to be %v, got %v", body.SomeInt64, someInt64)
		}
		if someBool != body.SomeBool {
			t.Errorf("expected someBool to be %v, got %v", body.SomeBool, someBool)
		}
	})

	t.Run("invalid request body", func(t *testing.T) {
		app := testutils.NewTestApp(t)
		defer app.Close()

		controller := users.NewCreateUserController(app.App)
		app.TestRouter.Post("/users", controller.CreateUserHandler)

		payload := map[string]interface{}{
			"invalid": "",
		}
		req := testutils.CreatePostRequest(t, "/users", payload)
		rr := app.MakeRequest(req)

		if rr.Code != http.StatusUnprocessableEntity {
			t.Errorf("Expected status code 422 Unprocessable Entity, got %d", rr.Code)
		}
	})

	t.Run("failed request validation", func(t *testing.T) {
		app := testutils.NewTestApp(t)
		defer app.Close()

		controller := users.NewCreateUserController(app.App)
		app.TestRouter.Post("/users", controller.CreateUserHandler)

		body := users.CreateUserRequest{
			Name:  "",
			Email: "invalidemail",
		}

		req := testutils.CreatePostRequest(t, "/users", body)
		rr := app.MakeRequest(req)

		if rr.Code != http.StatusBadRequest {
			t.Errorf("Expected status code 400 Bad Request, got %d", rr.Code)
		}

		// Verify error message
		var errorResponse testutils.ValidationErrorResponse
		err := json.Unmarshal(rr.Body.Bytes(), &errorResponse)

		if err != nil {
			t.Fatal(err)
		}

		if len(errorResponse.Errors) == 0 {
			t.Error("Expected validation errors, got none")
		}

		if errorResponse.Errors[0].Field != "name" {
			t.Errorf("Expected error field to be 'name', got %s", errorResponse.Errors[0].Field)
		}

		if errorResponse.Errors[0].Message != "Name is required" {
			t.Errorf("Expected error message to be 'Name is required', got %s", errorResponse.Errors[0].Message)
		}

		if errorResponse.Errors[1].Field != "email" {
			t.Errorf("Expected error field to be 'email', got %s", errorResponse.Errors[1].Field)
		}

		if errorResponse.Errors[1].Message != "Email must be a valid email address" {
			t.Errorf("Expected error message to be 'Email must be a valid email address', got %s", errorResponse.Errors[1].Message)
		}

	})

	t.Run("failed unique constraints", func(t *testing.T) {
		app := testutils.NewTestApp(t)
		defer app.Close()

		controller := users.NewCreateUserController(app.App)
		app.TestRouter.Post("/users", controller.CreateUserHandler)

		users.CreateUser(context.Background(), app.DB(), &users.CreateUserRequest{
			Name:  "name",
			Email: "email@example.com",
		})

		payload := users.CreateUserRequest{
			Name:  "name",
			Email: "email@example.com",
		}

		req := testutils.CreatePostRequest(t, "/users", payload)
		rr := app.MakeRequest(req)

		if rr.Code != http.StatusBadRequest {
			t.Errorf("Expected status code 400 Bad Request, got %d", rr.Code)
		}

		var errorResponse testutils.ValidationErrorResponse
		err := json.Unmarshal(rr.Body.Bytes(), &errorResponse)

		if err != nil {
			t.Fatal(err)
		}

		if len(errorResponse.Errors) == 0 {
			t.Error("Expected validation errors, got none")
		}

		if errorResponse.Errors[0].Field != "name" {
			t.Errorf("Expected error field to be 'name', got %s", errorResponse.Errors[0].Field)
		}

		if errorResponse.Errors[0].Message != "Name already exists" {
			t.Errorf("Expected error message to be 'Name already exists', got %s", errorResponse.Errors[0].Message)
		}

		if errorResponse.Errors[1].Field != "email" {
			t.Errorf("Expected error field to be 'email', got %s", errorResponse.Errors[1].Field)
		}

		if errorResponse.Errors[1].Message != "Email already exists" {
			t.Errorf("Expected error message to be 'Email already exists', got %s", errorResponse.Errors[1].Message)
		}

	})
}
